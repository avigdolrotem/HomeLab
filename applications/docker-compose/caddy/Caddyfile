# Global options
{
    # Email for Let's Encrypt
    email admin@avigdol.com

    # ACME server (use staging for testing)
    acme_ca https://acme-staging-v02.api.letsencrypt.org/directory

    # Production Let's Encrypt (default)
    # acme_ca https://acme-v02.api.letsencrypt.org/directory
}

# Vaultwarden - Password Manager
passwords.avigdol.com {
    reverse_proxy vaultwarden:80

    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    reverse_proxy @websockets vaultwarden:3012

    header {
        Strict-Transport-Security max-age=31536000;
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options nosniff
        Referrer-Policy same-origin
    }

    log {
        output file /var/log/caddy/passwords.avigdol.com.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
    }
}

# Nextcloud - File Sync
files.avigdol.com {
    reverse_proxy nextcloud:80

    redir /.well-known/carddav /remote.php/dav permanent
    redir /.well-known/caldav /remote.php/dav permanent

    header {
        Strict-Transport-Security max-age=31536000;
        X-Frame-Options SAMEORIGIN
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options nosniff
        Referrer-Policy same-origin
        -Server
    }

    request_body {
        max_size 512MB
    }

    log {
        output file /var/log/caddy/files.avigdol.com.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
    }
}

# Jenkins - CI/CD
jenkins.avigdol.com {
    reverse_proxy jenkins:8080

    header {
        Strict-Transport-Security max-age=31536000;
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options nosniff
    }

    log {
        output file /var/log/caddy/jenkins.avigdol.com.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
    }
}

# Grafana - Monitoring Dashboard
monitor.avigdol.com {
    reverse_proxy grafana:3000

    header {
        Strict-Transport-Security max-age=31536000;
        X-Frame-Options SAMEORIGIN
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options nosniff
    }

    log {
        output file /var/log/caddy/monitor.avigdol.com.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
    }
}

# Webmail (Roundcube)
webmail.avigdol.com {
    reverse_proxy webmail:80

    header {
        Strict-Transport-Security max-age=31536000;
        X-Frame-Options SAMEORIGIN
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options nosniff
        Referrer-Policy same-origin
    }

    log {
        output file /var/log/caddy/webmail.avigdol.com.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
    }
}

# Serve MTA-STS policy (required for strict TLS in email)
mta-sts.avigdol.com {
    root * /srv/mta-sts
    file_server
}

# Caddy Admin API (for internal use only)
:2019 {
    bind 127.0.0.1
}
