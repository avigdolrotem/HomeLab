#!/bin/bash

ENV_DIR="/home/ubuntu/homelab/docker-compose/.env.d"
mkdir -p "$ENV_DIR"

APPS=("vaultwarden" "nextcloud" "grafana" "jenkins")

for APP in "${APPS[@]}"; do
    SECRET_NAME="homelab-dev-${APP}-db"
    SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id "$SECRET_NAME" --query SecretString --output text 2>/dev/null)
    
    if [ $? -eq 0 ] && [ -n "$SECRET_JSON" ]; then
        echo "$SECRET_JSON" | jq -r '
          "DATABASE_URL=" + .url,
          "DB_HOST=" + .host,
          "DB_PORT=" + (.port | tostring),
          "DB_NAME=" + .database,
          "DB_USER=" + .username,
          "DB_PASSWORD=" + .password
        ' > "$ENV_DIR/${APP}-db.env"
        chmod 600 "$ENV_DIR/${APP}-db.env"
    fi
done